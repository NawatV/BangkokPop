<html>
    <head>
        <meta charset="UTF-8">
        <title> Test Print to Excel </title>
    </head>
    <body>

        <?php
//================================= SAME =====================================================
        ini_set('max_execution_time', 0);
        ini_set('memory_limit', '-1');
        // <editor-fold defaultstate="collapsed" desc="Head For Excel"> 

        /** PHPExcel */
        require_once 'Classes/PHPExcel.php';


        /** PHPExcel_Writer_Excel2007 */
        include 'Classes/PHPExcel/Writer/Excel2007.php';

        /** Include path * */
        ini_set('include_path', ini_get('include_path') . ';../Classes/');

        // Create new PHPExcel object
        echo date('H:i:s') . " Create new PHPExcel object<br>";
        $objPHPExcel = new PHPExcel();

        // Set properties
        echo date('H:i:s') . " Set properties<br>";
        $objPHPExcel->getProperties()->setCreator("Muk Natthaporn");
        $objPHPExcel->getProperties()->setLastModifiedBy("Muk Natthaporn");
        $objPHPExcel->getProperties()->setTitle("Result Document_Title");
        $objPHPExcel->getProperties()->setSubject("Result Document_Subject");
        $objPHPExcel->getProperties()->setDescription("Generated By PHP classes");
        // </editor-fold>
        // <editor-fold defaultstate="collapsed" desc="Connect to MySQL Database">
        $objConnect = mysql_connect("localhost", "root", "") or die("เชื่อมต่อฐานข้อมูลไม่ได้"); //changed
        $objDB = mysql_select_db("SimPhit") or die("เลือกฐานข้อมูลไม่ได้"); //SimPhitlok
        $table = 'People';
        mysql_query("SET NAMES UTF8");
        mysql_query("SET character_set_results=UTF8");
        mysql_query("SET character_set_client=UTF8");
        mysql_query("SET character_set_connection=UTF8");
        // </editor-fold>
        // Add some data
        echo date('H:i:s') . " Add data<br>";
        $objPHPExcel->setActiveSheetIndex(0);

        $arrLocal = array();
        for ($i = 1; $i <= 9; $i++) {
            $str = "SELECT Location ,Area , HOUSENUM "
                    . "FROM `people` "
                    . "WHERE HOUSENUM != 0 "
                    . "GROUP BY HOUSENUM "
                    . "HAVING COUNT(*) = $i "
                    . "ORDER BY ID";
            echo $str . "<br>";
            $result = mysql_query($str) or die(mysql_error());
            while ($saveAll = mysql_fetch_object($result)) {
                if (!isset($arrLocal[$saveAll->Location][$saveAll->Area][$i])) {
                    $arrLocal[$saveAll->Location][$saveAll->Area][$i] = 0;
                }
                $arrLocal[$saveAll->Location][$saveAll->Area][$i] ++;
            }
            mysql_free_result($result);
        }

        $str = "SELECT Location ,Area , HOUSENUM "
                . "FROM `people` "
                . "WHERE HOUSENUM != 0 "
                . "GROUP BY HOUSENUM "
                . "HAVING COUNT(*) > 9 "
                . "ORDER BY ID";
        echo $str . "<br>";
        $result = mysql_query($str) or die(mysql_error());
        while ($saveAll = mysql_fetch_object($result)) {
            if (!isset($arrLocal[$saveAll->Location][$saveAll->Area][$i])) {
                $arrLocal[$saveAll->Location][$saveAll->Area][10] = 0;
            }
            $arrLocal[$saveAll->Location][$saveAll->Area][10] ++;
        }
        mysql_free_result($result);

        $r = 2;
        foreach ($arrLocal as $keyL => $valueL) {
            foreach ($valueL as $keyA => $valueA) {
                $c = 0;
                echo "$keyL $keyA ";
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $keyL);
                $c++;
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $keyA);
                $c++;

                for ($i = 1; $i <= 10; $i++) {
                    if (isset($valueA[$i])) {
                        echo $valueA[$i] . " ";
                        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $valueA[$i]);
                        $c++;
                    } else {
                        echo "0 ";
                        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "0");
                        $c++;
                    }
                }
                echo "<br>";
                $r ++;
            }
        }

//        $r = 2;
//        foreach ($arrayResult as $keyG => $valueG) {
//            foreach ($valueG as $keyA => $valueA) {
//                foreach ($valueA as $keyN => $valueN) {
//
//                    echo $keyG . " " . $keyA . " " . $keyN . " ";
//                    $c = 0;
//                    $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $keyG);
//                    $c++;
//                    $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $keyA);
//                    $c++;
//                    $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $keyN);
//                    $c++;
//                    for ($z = 0; $z < 13; $z++) {
//                        if (isset($valueN[$z])) {
//                            echo $valueN[$z] . " ";
//                            $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $valueN[$z]);
//                            $c++;
//                        } else {
//                            echo "0 ";
//                            $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "0");
//                            $c++;
//                        }
//                    }
//                    echo "<br>";
//                    $r++;
//                }
//            }
//        }

        mysql_close($objConnect);

        // <editor-fold defaultstate="collapsed" desc="Tail For Excel"> 
        // Rename sheet
        echo date('H:i:s') . " Rename sheet<br>";
        $objPHPExcel->getActiveSheet()->setTitle('Simple');


        // Save Excel 2007 file
        echo date('H:i:s') . " Write to Excel2007 format<br>";
        $objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
        $objWriter->save(str_replace('.php', '.xlsx', __FILE__));

        // Echo done
        echo date('H:i:s') . " Done writing file.<br>";
        // </editor-fold>
        ?>
    </body>
</html>