<html>
    <head>
        <meta charset="UTF-8">
        <title> Test Print to Excel </title>
    </head>
    <body>

        <?php
//================================= SAME =====================================================
        ini_set('max_execution_time', 0);
        ini_set('memory_limit', '-1');
        // <editor-fold defaultstate="collapsed" desc="Head For Excel"> 

        /** PHPExcel */
        require_once 'Classes/PHPExcel.php';


        /** PHPExcel_Writer_Excel2007 */
        include 'Classes/PHPExcel/Writer/Excel2007.php';

        /** Include path * */
        ini_set('include_path', ini_get('include_path') . ';../Classes/');

        // Create new PHPExcel object
        echo date('H:i:s') . " Create new PHPExcel object<br>";
        $objPHPExcel = new PHPExcel();

        // Set properties
        echo date('H:i:s') . " Set properties<br>";
        $objPHPExcel->getProperties()->setCreator("Muk Natthaporn");
        $objPHPExcel->getProperties()->setLastModifiedBy("Muk Natthaporn");
        $objPHPExcel->getProperties()->setTitle("Result Document_Title");
        $objPHPExcel->getProperties()->setSubject("Result Document_Subject");
        $objPHPExcel->getProperties()->setDescription("Generated By PHP classes");
        // </editor-fold>
        // <editor-fold defaultstate="collapsed" desc="Connect to MySQL Database">
        $objConnect = mysql_connect("localhost", "root", "") or die("เชื่อมต่อฐานข้อมูลไม่ได้"); //changed
        $objDB = mysql_select_db("SimPhit") or die("เลือกฐานข้อมูลไม่ได้"); //SimPhitlok
        $table = 'People';
        mysql_query("SET NAMES UTF8");
        mysql_query("SET character_set_results=UTF8");
        mysql_query("SET character_set_client=UTF8");
        mysql_query("SET character_set_connection=UTF8");
        // </editor-fold>
        // Add some data
        echo date('H:i:s') . " Add data<br>";
        $objPHPExcel->setActiveSheetIndex(0);

        $start = array(15, 20, 25, 30, 35, 40, 45);
        $end = array(19, 24, 29, 34, 39, 44, 49);

        $arrFemale = array();
        $arrSpouse = array();
        $diffResult = array();
        $countFemale = 0;
        $countMale = 0;
        $countAllFemale = array();
        for ($i = 0; $i < 7; $i++) {
            $str = "SELECT  ID , temp "
                    . "FROM `" . $table . "` "
                    . "WHERE `temp`>= " . $start[$i] . " "
                    . "AND `temp` <= " . $end[$i] . " "
                    . "AND Marital_Status = 'สมรส' "
                    . "AND Gender = 'Female' "
                    . "AND SPOUSE_ID != 0 ";
            echo $str . "<br>";

            $result = mysql_query($str) or die(mysql_error());

            while ($saveAll = mysql_fetch_object($result)) {
                $arrFemale[$i][$saveAll->ID] = $saveAll->temp;
                $countFemale++;
            }
            mysql_free_result($result);
            
            $str = "SELECT  ID , temp "
                    . "FROM `" . $table . "` "
                    . "WHERE `temp`>= " . $start[$i] . " "
                    . "AND `temp` <= " . $end[$i] . " "
                    . "AND Marital_Status = 'สมรส' "
                    . "AND Gender = 'Female' ";
            echo $str . "<br>";

            $resultC = mysql_query($str) or die(mysql_error());
            $countAllFemale[$i] = mysql_num_rows($resultC);
            mysql_free_result($resultC); 
        }

        $str = "SELECT  SPOUSE_ID , temp "
                . "FROM `" . $table . "` "
                . "WHERE Marital_Status = 'สมรส' "
                . "AND Gender = 'male' "
                . "AND SPOUSE_ID != 0 ";
        echo $str . "<br>";

        $result = mysql_query($str) or die(mysql_error());

        while ($saveAll = mysql_fetch_object($result)) {
            $arrSpouse[$saveAll->SPOUSE_ID] = $saveAll->temp;
            $countMale++;
        }
        mysql_free_result($result);


        echo "count Female = $countFemale<br>";
        echo "count Male = $countMale<br><br>";
        $countFemaleIncal = 0;

        for ($i = 0; $i < 7; $i++) {
            foreach ($arrFemale[$i] as $keyID => $valueAge) {
                $countFemaleIncal ++;
                if (isset($arrSpouse[$keyID])) {
                    //have spouse
                    $diffAge = $valueAge - $arrSpouse[$keyID];

                    //echo $keyID ." ".$diffAge ."()_+<br>";
                    
                    $diffCase = NULL;
                    if ($diffAge >= 5 && $diffAge <= 7) {
                        $diffCase = 0;
                    } else if ($diffAge >= 3 && $diffAge <= 4) {
                        $diffCase = 1;
                    } else if ($diffAge >= 1 && $diffAge <= 2) {
                        $diffCase = 2;
                    } else if ($diffAge == 0) {
                        $diffCase = 3;
                    } else if ($diffAge >= -2 && $diffAge <= -1) {
                        $diffCase = 4;
                    } else if ($diffAge >= -4 && $diffAge <= -3) {
                        $diffCase = 5;
                    } else if ($diffAge >= -15 && $diffAge <= -5) {
                        $diffCase = 6;
                    } else {
                        //$diffCase = 8;
                        echo "$keyID $diffAge !<br>";
                    }

                    if (!isset($diffResult[$i][$diffCase])) {
                        $diffResult[$i][$diffCase] = 1;
                    } else {
                        $diffResult[$i][$diffCase] ++;
                    }
                }
            }
        }


        echo "Female in Cal $countFemaleIncal <br>";
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow(12, 1, "รวมหญิงทั้งหมด");
        $r = 2;
        
            foreach ($diffResult as $keyD => $valueD) {
                echo $keyD . " ";
                $c = 0;
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "Female");
                $c++;
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "สมรส");
                $c++;
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $start[$keyD]);
                $c++;
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $end[$keyD]);
                $c++;
                for ($i = 0; $i < 7; $i++) {
                    if (isset($valueD[$i])) {
                        echo "$i [" . $valueD[$i] . "] ";
                        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $valueD[$i]);
                        $c++;
                    } else {
                        echo "$i [0] ";
                        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "0");
                        $c++;
                    }
                    
                }
                $c++;
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r,$countAllFemale[$keyD] );
                echo "<br>";
                $r++;
            }
            echo "<br>";
            $r++;
        

        mysql_close($objConnect);

        // <editor-fold defaultstate="collapsed" desc="Tail For Excel"> 
        // Rename sheet
        echo date('H:i:s') . " Rename sheet<br>";
        $objPHPExcel->getActiveSheet()->setTitle('Simple');


        // Save Excel 2007 file
        echo date('H:i:s') . " Write to Excel2007 format<br>";
        $objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
        $objWriter->save(str_replace('.php', '.xlsx', __FILE__));

        // Echo done
        echo date('H:i:s') . " Done writing file.<br>";
        // </editor-fold>
        ?>
    </body>
</html>