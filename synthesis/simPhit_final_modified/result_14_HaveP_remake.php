<html>
    <head>
        <meta charset="UTF-8">
        <title> Test Print to Excel </title>
    </head>
    <body>

        <?php
//================================= SAME =====================================================
        ini_set('max_execution_time', 0);
        ini_set('memory_limit', '-1');
        // <editor-fold defaultstate="collapsed" desc="Head For Excel"> 

        /** PHPExcel */
        require_once 'Classes/PHPExcel.php';


        /** PHPExcel_Writer_Excel2007 */
        include 'Classes/PHPExcel/Writer/Excel2007.php';

        /** Include path * */
        ini_set('include_path', ini_get('include_path') . ';../Classes/');

        // Create new PHPExcel object
        echo date('H:i:s') . " Create new PHPExcel object<br>";
        $objPHPExcel = new PHPExcel();

        // Set properties
        echo date('H:i:s') . " Set properties<br>";
        $objPHPExcel->getProperties()->setCreator("Muk Natthaporn");
        $objPHPExcel->getProperties()->setLastModifiedBy("Muk Natthaporn");
        $objPHPExcel->getProperties()->setTitle("Result Document_Title");
        $objPHPExcel->getProperties()->setSubject("Result Document_Subject");
        $objPHPExcel->getProperties()->setDescription("Generated By PHP classes");
        // </editor-fold>
        // <editor-fold defaultstate="collapsed" desc="Connect to MySQL Database">
        $objConnect = mysql_connect("localhost", "root", "") or die("เชื่อมต่อฐานข้อมูลไม่ได้"); //changed
        $objDB = mysql_select_db("SimPhit") or die("เลือกฐานข้อมูลไม่ได้"); //SimPhitlok
        $table = 'People';
        mysql_query("SET NAMES UTF8");
        mysql_query("SET character_set_results=UTF8");
        mysql_query("SET character_set_client=UTF8");
        mysql_query("SET character_set_connection=UTF8");
        // </editor-fold>
        // Add some data
        echo date('H:i:s') . " Add data<br>";
        $objPHPExcel->setActiveSheetIndex(0);

        $str = "SELECT HH_ID , COUNT(HH_ID) AS CHID FROM `" . $table . "` "
                . "WHERE HH_Status != '' "
                . "GROUP BY HH_ID "
                . "HAVING COUNT(HH_ID) = 2";
        echo $str . "<br>";
        $countFamily = 0;
        $resultF = mysql_query($str) or die(mysql_error());
        while ($saveAll = mysql_fetch_object($resultF)) {
            $arrFamily[$saveAll->HH_ID] = $saveAll->CHID;
            $countFamily++;
        }
        //echo $countFamily . "<br>";
        //mysql_free_result($resultF);

        $str = "SELECT HH_ID , ID , Gender FROM `" . $table . "` "
                . "WHERE HH_ID != 0 ";
        echo $str . "<br>";
        $countHHID = 0;
        $resultHHID = mysql_query($str) or die(mysql_error());
        while ($saveAll = mysql_fetch_object($resultHHID)) {
            $arrHHID[$saveAll->ID] = $saveAll->HH_ID;
            $countHHID++;
        }
        //echo $countHHID . "<br>";
        //mysql_free_result($resultHHID);

        $str = "SELECT ID , Gender ,Marital_Status,UNKNOWN_CHILD FROM `" . $table . "` "
                . "WHERE 1 ";
        echo $str . "<br>";
        $countAPP = 0;
        $resultAPP = mysql_query($str) or die(mysql_error());
        while ($saveAll = mysql_fetch_object($resultAPP)) {
            $arrAPP[$saveAll->ID] = array("GEN" => $saveAll->Gender
                , "MAR" => $saveAll->Marital_Status
                , "UNCHILD" => $saveAll->UNKNOWN_CHILD);
            $countAPP++;
        }
        echo $countAPP . "<br>";
        mysql_free_result($resultAPP);

        $arrChild = array();
        $countChild = 0;
        $str = "SELECT ID , HaveParentID FROM `" . $table . "` "
                . "WHERE temp < 18 ";
        echo $str . "<br>";
        $result = mysql_query($str) or die(mysql_error());
        while ($saveAll = mysql_fetch_object($result)) {
            $arrChild[$saveAll->ID] = $saveAll->HaveParentID;
            $countChild++;
        }
        echo $countChild . "<br>";
        mysql_free_result($result);

        $arrHAlone = array();
        $countHAlone = 0;
        $str = "SELECT ID , HeadAlone FROM `" . $table . "` "
                . "WHERE HeadAlone = 1 ";
        echo $str . "<br>";
        $resultHA = mysql_query($str) or die(mysql_error());
        while ($saveAll = mysql_fetch_object($resultHA)) {
            $arrHAlone[$saveAll->ID] = $saveAll->HeadAlone;
            $countHAlone++;
        }
        echo $countHAlone . "<br>";
        mysql_free_result($resultHA);

        $withFamily = 0;
        $withAlone = 0;
        $whitFather = 0;
        $withMom = 0;

        // <editor-fold defaultstate="collapsed" desc="Base On Spouse"> 
//        foreach ($arrChild as $keyC => $valueC) {
//            if ($valueC != 0) {
//                if (isset($arrHHID[$valueC])) {
//                    $HHID = $arrHHID[$valueC];
//                    if (isset($arrFamily[$HHID])) {
//                        $withFamily++;
//                    } else {
//                        $gender = $arrAPP[$valueC];
//                        if ($gender == "male") {
//                            $whitFather++;
//                        } else if ($gender == "female") {
//                            $withMom++;
//                        }
//                    }
//                } else {
//                    $gender = $arrAPP[$valueC];
//                    if ($gender == "male") {
//                        $whitFather++;
//                    } else if ($gender == "female") {
//                        $withMom++;
//                    }
//                }
//            } else {
//                $withAlone++;
//            }
//        }
//
//        echo $withFamily . " " . $withAlone . " " . $withMom . " " . $whitFather . "<br>";
//        echo "All = " . ($withFamily + $withAlone + $withMom + $whitFather) . "<br>";
        // </editor-fold>
        //Base On Marital
        $isTrue = "TRUE";
        foreach ($arrChild as $keyC => $valueC) {
            if ($valueC != 0) {
                if ($arrAPP[$valueC]["GEN"] == "male") {
                    $whitFather++;
                } else {
                    if ($arrAPP[$valueC]["MAR"] == "สมรส") {
                        if (isset($arrHAlone[$valueC])) {
                            $withMom++;
                        } else {
                            $withFamily++;
                        }
                    } else {
                        $withMom++;
                    }
                    ///////////////////////Check 12 remake/////////////////////
                    if ($arrAPP[$valueC]["UNCHILD"] == 1) {
                        $isTrue = "FALSE";
                    }
                }
            } else {
                $withAlone++;
            }
        }

        echo "WF " . $withFamily . " WA" . $withAlone . " WM" . $withMom . " WD" . $whitFather . "<br>";
        echo "All = " . ($withFamily + $withAlone + $withMom + $whitFather) . "<br><br>";
        echo "******ไม่มีคนไม่ทราบจำนวนบุตรมีลูก = $isTrue ******<br><br>";
        $r = 2;
        $c = 0;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $withFamily);
        $c++;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $withAlone);
        $c++;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $withMom);
        $c++;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $whitFather);


        $strUpHHStatus = "UPDATE `" . $table . "` "
                . "SET HH_STATUS = 'Child' "
                . "WHERE HH_STATUS != 'Head' "
                . "AND HH_STATUS != 'Spouse' "
                . "AND HaveParentID != 0 ";
        echo $strUpHHStatus . "<br>";
        mysql_query($strUpHHStatus) or die(mysql_error());
        
        $strUpHHStatus = "UPDATE `" . $table . "` "
                . "SET HH_STATUS = 'Other' "
                . "WHERE HH_STATUS != '' ";
        echo $strUpHHStatus . "<br>";
        mysql_query($strUpHHStatus) or die(mysql_error());

        mysql_close($objConnect);

        // <editor-fold defaultstate="collapsed" desc="Tail For Excel"> 
        // Rename sheet
        echo date('H:i:s') . " Rename sheet<br>";
        $objPHPExcel->getActiveSheet()->setTitle('Simple');


        // Save Excel 2007 file
        echo date('H:i:s') . " Write to Excel2007 format<br>";
        $objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
        $objWriter->save(str_replace('.php', '.xlsx', __FILE__));

        // Echo done
        echo date('H:i:s') . " Done writing file.<br>";
        // </editor-fold>
        ?>
    </body>
</html>