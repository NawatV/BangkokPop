<html>
    <head>
        <meta charset="UTF-8">
        <title> Test Print to Excel </title>
    </head>
    <body>

        <?php
//-------------- Initiation (same)-----------------------------------------------------
        ini_set('max_execution_time', 0);
        ini_set('memory_limit', '-1');
        // <editor-fold defaultstate="collapsed" desc="Head For Excel"> 

        /** PHPExcel */
        require_once 'Classes/PHPExcel.php';


        /** PHPExcel_Writer_Excel2007 */
        include 'Classes/PHPExcel/Writer/Excel2007.php';

        /** Include path * */
        ini_set('include_path', ini_get('include_path') . ';../Classes/');

        // Create new PHPExcel object
        echo " Create new PHPExcel object<br>";
        $objPHPExcel = new PHPExcel();

        // Set properties
        echo " Set properties<br>";
        $objPHPExcel->getProperties()->setCreator("Muk Natthaporn");
        $objPHPExcel->getProperties()->setLastModifiedBy("Muk Natthaporn");
        $objPHPExcel->getProperties()->setTitle("Result Document_Title");
        $objPHPExcel->getProperties()->setSubject("Result Document_Subject");
        $objPHPExcel->getProperties()->setDescription("Generated By PHP classes");
        // </editor-fold>
        // <editor-fold defaultstate="collapsed" desc="Connect to MySQL Database">
        $objConnect = mysql_connect("localhost", "root", "") or die("เชื่อมต่อฐานข้อมูลไม่ได้"); //changed
        $objDB = mysql_select_db("SimPhit") or die("เลือกฐานข้อมูลไม่ได้"); //SimPhitLok
        $table = 'People';
        mysql_query("SET NAMES UTF8");
        mysql_query("SET character_set_results=UTF8");
        mysql_query("SET character_set_client=UTF8");
        mysql_query("SET character_set_connection=UTF8");
        // </editor-fold>
        // Add some data
        echo " Add data<br>";

//----------------- result_4_area ----------------------------------------------------------------
        $Location = array();
        $array_location[1] = "อ.เมืองพิษณุโลก";
        $array_location[2] = "อ.นครไทย";
        $array_location[3] = "อ.ชาติตระการ";
        $array_location[4] = "อ.บางระกำ";
        $array_location[5] = "อ.บางกระทุ่ม";
        $array_location[6] = "อ.พรหมพิราม";
        $array_location[7] = "อ.วัดโบสถ์";
        $array_location[8] = "อ.วังทอง";
        $array_location[9] = "อ.เนินมะปราง";

        $area = array();
        $area[1] = "นอกเขตเทศบาล";
        $area[2] = "ในเขตเทศบาล";
        echo "Gender Location นอกเขตเทศบาล ในเขตเทศบาล";

        $r = 1;
        $c = 0;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "Gender");
        $c++;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "Location");
        $c++;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "นอกเขตเทศบาล");
        $c++;
        $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "ในเขตเทศบาล");

        $str= mysql_query("SELECT count(*) as number FROM `" . $table . "` where 1");
        $all = mysql_fetch_assoc($str);

        foreach ($array_location as $key => $value) {
            $r++;
            $c = 0;
            $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "male");
            $c++;
            $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $value);
            $c++;
            echo "<br>";
            foreach ($area as $key1 => $value1) {
                $MMale = mysql_query("SELECT count(*) as number FROM `" . $table . "` where Gender = 'Male' and Location = '" . $value . "' and Area = '" . $value1 . "'");
                $Male = mysql_fetch_assoc($MMale);
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, ($Male['number']/$all['number']*100));
                $c++;
                echo $Male['number'] . " ";
            }
        }
        foreach ($array_location as $key => $value) {
            $r++;
            $c = 0;
            $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, "female");
            $c++;
            $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, $value);
            $c++;
            echo "<br>";
            foreach ($area as $key1 => $value1) {
                $MFemale = mysql_query("SELECT count(*) as number FROM `" . $table . "` where Gender = 'Female' and Location = '" . $value . "' and Area = '" . $value1 . "'");
                $Female = mysql_fetch_assoc($MFemale);
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($c, $r, ($Female['number']/$all['number']*100));
                $c++;
                echo $Female['number'] . " ";
            }
        }

        mysql_close($objConnect);

//---------------------- Modify --------------------------------------------------
        // <editor-fold defaultstate="collapsed" desc="Tail For Excel"> 
        // Rename sheet
        echo " Rename sheet<br>";
        $objPHPExcel->getActiveSheet()->setTitle('Simple');


        // Save Excel 2007 file
        echo " Write to Excel2007 format<br>";
        $objWriter = new PHPExcel_Writer_Excel2007($objPHPExcel);
        $objWriter->save(str_replace('.php', '.xlsx', __FILE__));

        // Echo done
        echo " Done writing file.<br>";
        // </editor-fold>
        ?>
    </body>
</html>
